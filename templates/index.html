<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burger - Audio Bridge</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            padding: 1rem;
        }

        @media (min-width: 640px) { body { padding: 2rem; } }

        .container { max-width: 72rem; margin: 0 auto; }

        /* Header */
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 { font-size: 2.25rem; font-weight: 800; color: #4338ca; letter-spacing: -0.025em; }
        @media (min-width: 640px) { h1 { font-size: 3rem; } }
        .subtitle { margin-top: 0.5rem; font-size: 1.125rem; color: #6b7280; }
        .version { margin-top: 0.25rem; font-size: 0.875rem; color: #9ca3af; font-weight: 600; }

        /* Status indicators */
        .status-row { margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .status-badge {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
        }
        .status-red { background-color: #fee2e2; color: #dc2626; }
        .status-green { background-color: #dcfce7; color: #16a34a; }
        .status-yellow { background-color: #fef9c3; color: #ca8a04; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }
        .status-blue { background-color: #dbeafe; color: #2563eb; }

        /* Error Banner */
        .error-banner {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        .error-banner.show { display: block; }
        .error-banner-title { font-weight: 600; color: #dc2626; margin-bottom: 0.25rem; }
        .error-banner-message { color: #991b1b; font-size: 0.875rem; }
        .error-banner-close {
            float: right;
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* Cards */
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }
        .card-indigo { border: 1px solid #e0e7ff; }
        .card-blue { border: 1px solid #dbeafe; }
        .card-green { border: 1px solid #d1fae5; }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-title-indigo { color: #4f46e5; }
        .card-title-blue { color: #2563eb; }
        .card-title-green { color: #059669; }
        .card-title svg { width: 1.5rem; height: 1.5rem; }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .info-item {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .info-label { font-size: 0.75rem; color: #6b7280; font-weight: 600; text-transform: uppercase; }
        .info-value { font-size: 1rem; color: #1f2937; font-weight: 600; margin-top: 0.25rem; }

        /* Grid layout */
        .grid { display: grid; gap: 2rem; }
        @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }

        /* Device lists */
        .device-list {
            max-height: 16rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .device-list::-webkit-scrollbar { width: 8px; }
        .device-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .device-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .device-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .device-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        .device-item-default { background-color: #f3f4f6; }
        .device-item-default:hover { background-color: #eef2ff; }
        .device-item-selected { background-color: #c7d2fe; border: 1px solid #818cf8; }
        .device-item-bt { background-color: #f9fafb; border: 1px solid #e5e7eb; }
        .device-item-bt:hover { background-color: #eff6ff; }
        .device-item-bt-connected { background-color: #dcfce7; border: 1px solid #86efac; }

        .device-name { font-weight: 600; color: #1f2937; }
        .device-model { font-size: 0.75rem; color: #6b7280; }
        .device-mac { font-size: 0.75rem; color: #9ca3af; margin-left: 0.5rem; }
        .device-action { font-size: 0.875rem; color: #9ca3af; }
        .device-action-active { font-weight: 700; color: #4338ca; }
        .device-action-connect { font-size: 0.75rem; color: #3b82f6; }
        .device-action-connected { font-size: 0.75rem; font-weight: 600; color: #16a34a; }

        .empty-message { color: #9ca3af; text-align: center; padding: 1rem; }

        /* Selected cast card */
        .selected-card {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.5rem;
        }
        .selected-card.hidden { display: none; }
        .selected-label { font-size: 0.875rem; font-weight: 500; color: #4338ca; }
        .selected-name { font-size: 1.125rem; font-weight: 600; color: #312e81; }

        /* Connected BT card */
        .bt-connected-card {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
        }
        .bt-connected-card.hidden { display: none; }
        .pulse-dot {
            position: relative;
            width: 0.75rem;
            height: 0.75rem;
            background-color: #22c55e;
            border-radius: 50%;
            margin-right: 0.75rem;
        }
        .pulse-dot::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #22c55e;
            animation: pulse-ring 1.5s ease-out infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        .bt-connected-label { font-size: 0.875rem; font-weight: 500; color: #15803d; }
        .bt-connected-name { font-size: 1.125rem; font-weight: 600; color: #14532d; }

        /* Not connected message */
        .bt-not-connected {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            color: #6b7280;
        }
        .bt-not-connected.hidden { display: none; }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease;
            margin-top: 0.5rem;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover:not(:disabled) { background-color: #dc2626; }
        .btn-blue { background-color: #3b82f6; color: white; }
        .btn-blue:hover:not(:disabled) { background-color: #2563eb; }
        .btn-green { background-color: #10b981; color: white; }
        .btn-green:hover:not(:disabled) { background-color: #059669; }
        .btn-yellow { background-color: #f59e0b; color: white; }
        .btn-yellow:hover:not(:disabled) { background-color: #d97706; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem; }

        /* BT devices section */
        .bt-devices-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f3f4f6;
        }
        .bt-devices-title { font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .bt-devices-hint { font-size: 0.75rem; color: #9ca3af; }
        .bt-device-list { max-height: 10rem; }

        /* Connection History */
        .history-list {
            max-height: 12rem;
            overflow-y: auto;
            font-size: 0.875rem;
        }
        .history-item {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .history-time { font-size: 0.75rem; color: #9ca3af; }
        .history-type { font-weight: 600; color: #4338ca; }
        .history-details { color: #6b7280; }

        /* Debug section */
        details {
            margin-top: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        summary { cursor: pointer; color: #4b5563; font-weight: 500; }
        .debug-buttons { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn-debug {
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .btn-debug:hover { background-color: #d1d5db; }
        .debug-output {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-family: monospace;
            overflow: auto;
            max-height: 12rem;
            white-space: pre-wrap;
        }

        /* Utility */
        .hidden { display: none !important; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-grow { flex-grow: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçî Burger - Audio Bridge</h1>
            <p class="subtitle">Stream Bluetooth audio to any Chromecast device.</p>
            <p class="version" id="version-display">v2.0.1</p>
            <div class="status-row">
                <span id="ws-status" class="status-badge status-red">Disconnected</span>
                <span id="stream-status" class="status-badge status-yellow">Stream Off</span>
                <span id="bt-status" class="status-badge status-gray">BT: Not Connected</span>
            </div>
        </header>

        <!-- Error Banner -->
        <div id="error-banner" class="error-banner">
            <button class="error-banner-close" onclick="dismissError()">√ó</button>
            <div class="error-banner-title">‚ö†Ô∏è Error</div>
            <div id="error-banner-message" class="error-banner-message"></div>
        </div>

        <!-- Devices Grid - Bluetooth on LEFT, Chromecast on RIGHT -->
        <div class="grid">
            <!-- Bluetooth Section (NOW ON LEFT) -->
            <div class="card card-blue flex-col">
                <div class="card-title card-title-blue">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                    </svg>
                    Bluetooth Source
                </div>

                <div id="bt-connected-card" class="bt-connected-card hidden">
                    <div class="pulse-dot"></div>
                    <div>
                        <p class="bt-connected-label">Connected Device:</p>
                        <p id="bt-connected-name" class="bt-connected-name"></p>
                    </div>
                </div>

                <div id="bt-not-connected" class="bt-not-connected">
                    No Bluetooth device connected. Make the bridge discoverable and connect from your phone or audio device.
                </div>

                <button id="scan-bt-btn" onclick="setPairMode()" class="btn btn-blue">
                    Make Bridge Discoverable (15s)
                </button>

                <div class="bt-devices-section">
                    <div class="bt-devices-title">Known BT Devices: <span class="bt-devices-hint">(click to connect)</span></div>
                    <div id="bt-list" class="device-list bt-device-list">
                        <p class="empty-message">Press 'Make Discoverable' to scan.</p>
                    </div>
                </div>
            </div>

            <!-- Chromecast Section (NOW ON RIGHT) -->
            <div class="card card-indigo flex-col">
                <div class="card-title card-title-indigo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Available Chromecasts (<span id="cast-count">0</span>)
                </div>

                <div id="selected-cast-card" class="selected-card hidden">
                    <p class="selected-label">Casting to:</p>
                    <p id="selected-cast-name" class="selected-name"></p>
                </div>

                <div id="cast-list" class="device-list flex-grow">
                    <p class="empty-message">Scanning for devices...</p>
                </div>

                <button id="stop-casting-btn" onclick="stopCasting()" class="btn btn-red" disabled>
                    Stop Casting
                </button>
            </div>
        </div>

        <!-- Stream Info Card (MOVED BELOW THE GRID) -->
        <div class="card">
            <div class="card-title" style="color: #059669;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Stream Information
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Audio Source</div>
                    <div id="info-source" class="info-value">‚Äî</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Stream Duration</div>
                    <div id="info-duration" class="info-value">‚Äî</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Bitrate</div>
                    <div id="info-bitrate" class="info-value">‚Äî</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sample Rate</div>
                    <div id="info-samplerate" class="info-value">‚Äî</div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="btn-group">
                <button onclick="restartStream()" class="btn btn-yellow">üîÑ Restart Stream</button>
                <button onclick="stopStream()" class="btn btn-red">‚èπÔ∏è Stop Stream</button>
            </div>
            <button onclick="reconnectBluetooth()" class="btn btn-green">üîµ Reconnect Bluetooth</button>
        </div>

        <!-- Connection History -->
        <details>
            <summary>üìú Connection History & Events</summary>
            <div id="connection-history" class="history-list" style="margin-top: 1rem;">
                <p class="empty-message">No connection events yet.</p>
            </div>
        </details>

        <!-- Debug Section -->
        <details>
            <summary>üîß Debug & Diagnostics</summary>
            <div class="debug-buttons">
                <button onclick="checkAudioSources()" class="btn-debug">Check Audio Sources</button>
                <button onclick="checkBluetoothAudio()" class="btn-debug">Bluetooth Audio Diag</button>
                <button onclick="testStream()" class="btn-debug">Test Stream in Browser</button>
                <button onclick="getFullStatus()" class="btn-debug">Full Status</button>
                <button onclick="clearErrors()" class="btn-debug">Clear Errors</button>
            </div>
            <div style="margin-top: 0.5rem;">
                <label style="font-size: 0.875rem; color: #4b5563;">Manual source override:</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                    <input type="text" id="manual-source" placeholder="e.g. bluez_source.XX_XX_XX_XX_XX_XX.a2dp_source"
                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                    <button onclick="setManualSource()" class="btn-debug">Set Source</button>
                </div>
            </div>
            <pre id="debug-output" class="debug-output"></pre>
        </details>
    </div>

    <script>
        var wsStatusEl = document.getElementById('ws-status');
        var streamStatusEl = document.getElementById('stream-status');
        var btStatusEl = document.getElementById('bt-status');
        var castListEl = document.getElementById('cast-list');
        var btListEl = document.getElementById('bt-list');
        var castCountEl = document.getElementById('cast-count');
        var selectedCastCardEl = document.getElementById('selected-cast-card');
        var selectedCastNameEl = document.getElementById('selected-cast-name');
        var stopCastingBtn = document.getElementById('stop-casting-btn');
        var scanBtBtn = document.getElementById('scan-bt-btn');
        var btConnectedCard = document.getElementById('bt-connected-card');
        var btNotConnected = document.getElementById('bt-not-connected');
        var btConnectedName = document.getElementById('bt-connected-name');
        var debugOutput = document.getElementById('debug-output');
        var versionDisplay = document.getElementById('version-display');
        var errorBanner = document.getElementById('error-banner');
        var errorBannerMessage = document.getElementById('error-banner-message');
        var connectionHistory = document.getElementById('connection-history');

        // Info fields
        var infoSource = document.getElementById('info-source');
        var infoDuration = document.getElementById('info-duration');
        var infoBitrate = document.getElementById('info-bitrate');
        var infoSampleRate = document.getElementById('info-samplerate');

        var ws;
        var errorDismissed = false; // Track if user dismissed the error
        var lastErrorMessage = null; // Track last error to avoid re-showing same error

        function connectWebSocket() {
            var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            var host = window.location.host;
            var wsUrl = protocol + '//' + host + '/ws';

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                wsStatusEl.className = 'status-badge status-green';
                wsStatusEl.textContent = 'Connected';
                // Load version and initial status on connect
                loadVersion();
                loadInitialStatus();
            };

            ws.onmessage = function(event) {
                try {
                    var data = JSON.parse(event.data);
                    updateUI(data);
                } catch (e) {
                    console.error("Failed to parse WebSocket message:", e);
                }
            };

            ws.onclose = function() {
                wsStatusEl.className = 'status-badge status-red';
                wsStatusEl.textContent = 'Disconnected';
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error("WebSocket Error:", error);
                ws.close();
            };
        }

        function loadVersion() {
            fetch('/api/version')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    versionDisplay.textContent = 'v' + data.version;
                })
                .catch(function(error) {
                    console.error('Error loading version:', error);
                });
        }

        function loadInitialStatus() {
            // Load full status on page load to populate chromecast list immediately
            fetch('/api/status/full')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    updateUI(data);
                })
                .catch(function(error) {
                    console.error('Error loading initial status:', error);
                });
        }

        function formatDuration(seconds) {
            if (!seconds) return '‚Äî';
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            var secs = seconds % 60;
            if (hours > 0) {
                return hours + 'h ' + minutes + 'm ' + secs + 's';
            } else if (minutes > 0) {
                return minutes + 'm ' + secs + 's';
            } else {
                return secs + 's';
            }
        }

        function updateUI(data) {
            // Stream status
            if (data.streaming) {
                streamStatusEl.className = 'status-badge status-green';
                streamStatusEl.textContent = 'Stream Active';
            } else {
                streamStatusEl.className = 'status-badge status-yellow';
                streamStatusEl.textContent = 'Stream Off';
            }

            // Bluetooth status
            if (data.bt_connected) {
                btStatusEl.className = 'status-badge status-green';
                btStatusEl.textContent = 'BT: ' + data.bt_connected;
                btConnectedCard.className = 'bt-connected-card';
                btNotConnected.className = 'bt-not-connected hidden';
                btConnectedName.textContent = data.bt_connected;
            } else {
                btStatusEl.className = 'status-badge status-gray';
                btStatusEl.textContent = 'BT: Not Connected';
                btConnectedCard.className = 'bt-connected-card hidden';
                btNotConnected.className = 'bt-not-connected';
            }

            // Stream info
            infoSource.textContent = data.audio_source || '‚Äî';
            infoBitrate.textContent = data.bitrate || '‚Äî';
            infoSampleRate.textContent = data.sample_rate ? (data.sample_rate + ' Hz') : '‚Äî';
            infoDuration.textContent = formatDuration(data.stream_duration);

            // Error banner - only show if error changed and user hasn't dismissed it
            if (data.last_error && data.last_error !== lastErrorMessage) {
                errorDismissed = false;
                lastErrorMessage = data.last_error;
            }

            if (data.last_error && !errorDismissed) {
                showErrorBanner(data.last_error);
            } else if (!data.last_error) {
                // Clear error if resolved
                hideErrorBanner();
                errorDismissed = false;
                lastErrorMessage = null;
            }

            // Connection history
            if (data.connection_history && data.connection_history.length > 0) {
                connectionHistory.innerHTML = '';
                data.connection_history.slice().reverse().forEach(function(event) {
                    var item = document.createElement('div');
                    item.className = 'history-item';
                    var time = new Date(event.timestamp).toLocaleTimeString();
                    item.innerHTML = '<div class="history-time">' + time + '</div>' +
                                   '<div><span class="history-type">' + event.type + ':</span> ' +
                                   '<span class="history-details">' + event.details + '</span></div>';
                    connectionHistory.appendChild(item);
                });
            }

            // Chromecasts
            castCountEl.textContent = data.casts.length;
            castListEl.innerHTML = '';

            if (data.casts.length === 0) {
                castListEl.innerHTML = '<p class="empty-message">No Chromecasts found on the network.</p>';
            }

            for (var i = 0; i < data.casts.length; i++) {
                var cast = data.casts[i];
                var isSelected = data.selected_cast === cast.uuid;
                var div = document.createElement('div');
                div.className = 'device-item ' + (isSelected ? 'device-item-selected' : 'device-item-default');
                div.setAttribute('data-uuid', cast.uuid);
                div.onclick = function() { selectCast(this.getAttribute('data-uuid')); };

                var infoDiv = document.createElement('div');
                var nameP = document.createElement('p');
                nameP.className = 'device-name';
                nameP.textContent = cast.name;
                var modelP = document.createElement('p');
                modelP.className = 'device-model';
                modelP.textContent = cast.model;
                infoDiv.appendChild(nameP);
                infoDiv.appendChild(modelP);

                var actionSpan = document.createElement('span');
                actionSpan.className = 'device-action' + (isSelected ? ' device-action-active' : '');
                actionSpan.textContent = isSelected ? '‚óè ACTIVE' : '‚ñ∂ Stream';

                div.appendChild(infoDiv);
                div.appendChild(actionSpan);
                castListEl.appendChild(div);
            }

            var activeCast = null;
            for (var j = 0; j < data.casts.length; j++) {
                if (data.casts[j].uuid === data.selected_cast) {
                    activeCast = data.casts[j];
                    break;
                }
            }

            if (activeCast) {
                selectedCastCardEl.className = 'selected-card';
                selectedCastNameEl.textContent = activeCast.name;
                stopCastingBtn.disabled = false;
            } else {
                selectedCastCardEl.className = 'selected-card hidden';
                selectedCastNameEl.textContent = '';
                stopCastingBtn.disabled = true;
            }

            // Bluetooth devices
            btListEl.innerHTML = '';
            if (data.bt_devices.length === 0) {
                btListEl.innerHTML = '<p class="empty-message">No devices discovered yet.</p>';
            }

            for (var k = 0; k < data.bt_devices.length; k++) {
                var device = data.bt_devices[k];
                var isConnected = data.bt_connected && data.bt_connected.indexOf(device.name) !== -1;
                var btDiv = document.createElement('div');
                btDiv.className = 'device-item ' + (isConnected ? 'device-item-bt-connected' : 'device-item-bt');
                btDiv.setAttribute('data-mac', device.mac);
                btDiv.setAttribute('data-name', device.name);
                btDiv.onclick = function() {
                    connectBtDevice(this.getAttribute('data-mac'), this.getAttribute('data-name'));
                };

                var btInfoDiv = document.createElement('div');
                var btNameSpan = document.createElement('span');
                btNameSpan.className = 'device-name';
                btNameSpan.textContent = device.name;
                var macSpan = document.createElement('span');
                macSpan.className = 'device-mac';
                macSpan.textContent = device.mac;
                btInfoDiv.appendChild(btNameSpan);
                btInfoDiv.appendChild(macSpan);

                var btActionSpan = document.createElement('span');
                btActionSpan.className = isConnected ? 'device-action-connected' : 'device-action-connect';
                btActionSpan.textContent = isConnected ? '‚óè Connected' : 'Connect ‚Üí';

                btDiv.appendChild(btInfoDiv);
                btDiv.appendChild(btActionSpan);
                btListEl.appendChild(btDiv);
            }
        }

        function showErrorBanner(message) {
            errorBannerMessage.textContent = message;
            errorBanner.className = 'error-banner show';
        }

        function hideErrorBanner() {
            errorBanner.className = 'error-banner';
        }

        function dismissError() {
            errorDismissed = true;
            hideErrorBanner();
        }

        function selectCast(uuid) {
            castListEl.innerHTML = '<p class="empty-message" style="color: #6366f1; font-weight: 600;">Initiating cast... This may take a few seconds.</p>';
            var encodedUuid = encodeURIComponent(uuid);
            fetch('/api/cast/select/' + encodedUuid, { method: 'POST' })
                .then(function(response) {
                    return response.json().then(function(data) {
                        return { ok: response.ok, data: data };
                    });
                })
                .then(function(result) {
                    if (!result.ok) {
                        throw new Error(result.data.detail || 'Failed to start casting.');
                    }
                    debugOutput.textContent = JSON.stringify(result.data, null, 2);
                })
                .catch(function(error) {
                    console.error('Cast error:', error);
                    errorDismissed = false;
                    showErrorBanner('Failed to start casting: ' + error.message);
                    debugOutput.textContent = 'Cast error: ' + error.message;
                });
        }

        function stopCasting() {
            fetch('/api/cast/stop', { method: 'POST' })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to stop casting.');
                    }
                })
                .catch(function(error) {
                    errorDismissed = false;
                    showErrorBanner('Error: ' + error.message);
                });
        }

        function setPairMode() {
            scanBtBtn.disabled = true;
            btListEl.innerHTML = '<p class="empty-message" style="color: #3b82f6;">Scanning for devices...</p>';

            // Countdown timer
            var secondsLeft = 15;
            scanBtBtn.textContent = 'Scanning... (' + secondsLeft + 's)';

            var countdownInterval = setInterval(function() {
                secondsLeft--;
                scanBtBtn.textContent = 'Scanning... (' + secondsLeft + 's)';
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);

            fetch('/api/scan-bt')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to initiate Bluetooth scan.');
                    }
                })
                .catch(function(error) {
                    errorDismissed = false;
                    showErrorBanner('Error: ' + error.message);
                    clearInterval(countdownInterval);
                })
                .finally(function() {
                    setTimeout(function() {
                        clearInterval(countdownInterval);
                        scanBtBtn.disabled = false;
                        scanBtBtn.textContent = 'Make Bridge Discoverable (15s)';
                    }, 15500);
                });
        }

        function connectBtDevice(mac, name) {
            if (!confirm('Connect to "' + name + '"?\n\nThis will pair (if needed) and connect to the device.')) {
                return;
            }

            debugOutput.textContent = 'Connecting to ' + name + ' (' + mac + ')...';

            fetch('/api/bt/pair/' + mac, { method: 'POST' })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    debugOutput.textContent = JSON.stringify(result, null, 2);

                    if (result.status === 'connected') {
                        btListEl.innerHTML = '<p class="empty-message" style="color: #22c55e; font-weight: 600;">Connected to ' + name + '!</p>';
                        errorDismissed = false;
                        hideErrorBanner();
                    } else if (result.status === 'paired') {
                        errorDismissed = false;
                        showErrorBanner('Paired with ' + name + ', but you may need to initiate connection from the device.');
                    } else if (result.status === 'timeout') {
                        errorDismissed = false;
                        showErrorBanner('Connection timed out. Make sure ' + name + ' is in pairing mode and try again.');
                    } else {
                        errorDismissed = false;
                        showErrorBanner('Connection issue: ' + (result.message || 'Unknown error'));
                    }
                })
                .catch(function(error) {
                    errorDismissed = false;
                    showErrorBanner('Error: ' + error.message);
                    debugOutput.textContent = 'Connection error: ' + error.message;
                });
        }

        function restartStream() {
            debugOutput.textContent = 'Restarting stream...';
            fetch('/api/stream/restart', { method: 'POST' })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    debugOutput.textContent = JSON.stringify(data, null, 2);
                    if (data.status === 'success') {
                        errorDismissed = false;
                        hideErrorBanner();
                    } else {
                        errorDismissed = false;
                        showErrorBanner(data.message || 'Failed to restart stream');
                    }
                })
                .catch(function(error) {
                    errorDismissed = false;
                    showErrorBanner('Error: ' + error.message);
                });
        }

        function stopStream() {
            fetch('/api/stream/stop', { method: 'POST' })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    debugOutput.textContent = JSON.stringify(data, null, 2);
                })
                .catch(function(error) {
                    errorDismissed = false;
                    showErrorBanner('Error: ' + error.message);
                });
        }

        function reconnectBluetooth() {
            debugOutput.textContent = 'Reconnecting Bluetooth...';
            fetch('/api/bluetooth/reconnect', { method: 'POST' })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    debugOutput.textContent = JSON.stringify(data, null, 2);
                    if (data.status === 'success') {
                        errorDismissed = false;
                        hideErrorBanner();
                    } else {
                        errorDismissed = false;
                        showErrorBanner(data.message || 'Failed to reconnect');
                    }
                })
                .catch(function(error) {
                    errorDismissed = false;
                    showErrorBanner('Error: ' + error.message);
                });
        }

        function checkAudioSources() {
            debugOutput.textContent = 'Fetching audio sources...';
            fetch('/api/audio-sources')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    debugOutput.textContent = JSON.stringify(data, null, 2);
                })
                .catch(function(error) {
                    debugOutput.textContent = 'Error: ' + error.message;
                });
        }

        function checkBluetoothAudio() {
            debugOutput.textContent = 'Running Bluetooth audio diagnostics...';
            fetch('/api/debug/bluetooth-audio')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    debugOutput.textContent = JSON.stringify(data, null, 2);
                })
                .catch(function(error) {
                    debugOutput.textContent = 'Error: ' + error.message;
                });
        }

        function getFullStatus() {
            debugOutput.textContent = 'Fetching full status...';
            fetch('/api/status/full')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    debugOutput.textContent = JSON.stringify(data, null, 2);
                })
                .catch(function(error) {
                    debugOutput.textContent = 'Error: ' + error.message;
                });
        }

        function clearErrors() {
            fetch('/api/errors/clear', { method: 'POST' })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    errorDismissed = false;
                    hideErrorBanner();
                    lastErrorMessage = null;
                    debugOutput.textContent = 'Errors cleared';
                })
                .catch(function(error) {
                    debugOutput.textContent = 'Error: ' + error.message;
                });
        }

        function testStream() {
            debugOutput.textContent = 'Starting audio playback test...';
            var audio = new Audio('/live.mp3');
            audio.oncanplay = function() {
                debugOutput.textContent = 'Audio stream connected. Playing...';
            };
            audio.onerror = function(e) {
                debugOutput.textContent = 'Audio error: ' + (e.message || 'Failed to load stream');
            };
            audio.play().then(function() {
                debugOutput.textContent = 'Audio stream started in browser. Check your speakers.\nIf you hear nothing, the source may be wrong.';
            }).catch(function(err) {
                debugOutput.textContent = 'Audio play error: ' + err.message;
            });
        }

        function setManualSource() {
            var sourceInput = document.getElementById('manual-source');
            var sourceName = sourceInput.value.trim();
            if (!sourceName) {
                errorDismissed = false;
                showErrorBanner('Please enter a source name');
                return;
            }
            debugOutput.textContent = 'Setting audio source to: ' + sourceName;
            fetch('/api/debug/set-source/' + encodeURIComponent(sourceName))
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    debugOutput.textContent = 'Source set:\n' + JSON.stringify(data, null, 2);
                })
                .catch(function(error) {
                    debugOutput.textContent = 'Error: ' + error.message;
                });
        }

        window.onload = connectWebSocket;
    </script>
</body>
</html>
